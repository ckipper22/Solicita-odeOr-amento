<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Solicitação de Orçamento - Multi-Itens</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      color: #333;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    h1 {
      color: #1e88e5;
      text-align: center;
      border-bottom: 3px solid #eee;
      padding-bottom: 10px;
      margin-top: 0;
    }
    .item-card {
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 6px;
      background: #f9f9f9;
      position: relative;
      display: flex;
      gap: 15px;
    }
    .item-image-col {
      flex-shrink: 0;
      width: 150px;
      text-align: center;
    }
    .item-image-preview {
      max-width: 100%;
      max-height: 100px;
      margin-top: 5px;
      border: 1px solid #ccc;
      padding: 3px;
      object-fit: contain;
      display: none;
      border-radius: 4px;
    }
    .item-fields-col {
      flex-grow: 1;
    }
    .form-group {
      margin-bottom: 10px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 3px;
      font-size: 0.9em;
    }
    input[type="text"],
    input[type="url"],
    input[type="number"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 0.9em;
    }
    input[type="number"] {
      width: 100px;
      text-align: right;
      font-weight: bold;
    }
    small {
      font-size: 0.75em;
      color: #a0522d;
      display: block;
      margin-top: 3px;
    }
    .btn-remove {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #e74c3c;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 0.8em;
    }
    .btn-remove:hover {
      background: #c0392b;
    }
    .button-group {
      margin-top: 20px;
      display: flex;
      gap: 15px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    .btn-action {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      flex-grow: 1;
      min-width: 150px;
    }
    #btnAddItem {
      background: #28a745;
      color: #fff;
    }
    #btnAddItem:hover {
      background: #218838;
    }
    #btnGerarPDF {
      background: #1e88e5;
      color: #fff;
    }
    #btnGerarPDF:hover {
      background: #1565c0;
    }

    @media (max-width: 768px) {
      .item-card { flex-direction: column; }
      .item-image-col { width: 100%; order: -1; }
      input[type="number"] { width: 100% !important; }
      .button-group { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="container" id="conteudoParaPDF">
    <h1>Solicitação de Orçamento - Multi-Itens</h1>
    <p style="text-align: center; font-size: 0.9em; color: #555;">
      Preencha os dados de cada produto desejado e clique em "Gerar Orçamento em PDF".
    </p>
    <div class="form-group" style="margin-top: 25px; padding: 10px; border: 1px dashed #ccc; border-radius: 4px;">
      <label for="orcamentoTitulo">Título da Proposta/Orçamento:</label>
      <input type="text" id="orcamentoTitulo" value="Orçamento de Produtos para Fornecedor" style="font-weight: bold; font-size: 1.1em;" />
    </div>
    <div id="itemsContainer" style="margin-top: 20px;"></div>
    <div class="button-group">
      <button type="button" id="btnAddItem" class="btn-action">+ Adicionar Item</button>
      <button type="button" id="btnGerarPDF" class="btn-action">Gerar Orçamento em PDF</button>
    </div>
  </div>

  <script>
    let itemCounter = 0;
    const itemsContainer = document.getElementById("itemsContainer");

    function addItem() {
      itemCounter++;
      const itemId = `item-${itemCounter}`;
      const itemHTML = `
      <div class="item-card" id="${itemId}">
        <button type="button" class="btn-remove" onclick="removeItem('${itemId}')">Remover</button>
        <div class="item-image-col">
          <label>Imagem (Ref.):</label>
          <input type="file" accept="image/*" class="file-input local-file-input" onchange="updateImagePreview(this, 'preview-url-${itemId}')"/>
          <img id="preview-url-${itemId}" src="" alt="Pré-visualização" class="item-image-preview"/>
          <p style="font-size:0.7em; margin-top:5px;">Anexe ou use endereço.</p>
        </div>
        <div class="item-fields-col">
          <div class="form-group">
            <label for="nome-produto-${itemId}">Nome/Descrição:</label>
            <input type="text" id="nome-produto-${itemId}" placeholder="Nome do Produto"/>
          </div>
          <div style="display:flex; gap:15px;">
            <div class="form-group" style="flex-grow:1;">
              <label for="link-img-${itemId}">Endereço da imagem:</label>
              <input type="url" id="link-img-${itemId}" class="input-url image-url-input" placeholder="https://..." oninput="updateImagePreview(this, 'preview-url-${itemId}')"/>
              <small>Só para visualização. Não vai pro PDF.</small>
            </div>
            <div class="form-group" style="width:150px;">
              <label for="quantidade-${itemId}">Qtd:</label>
              <input type="number" id="quantidade-${itemId}" value="1" min="1"/>
            </div>
          </div>
          <div class="form-group">
            <label for="link-referencia-${itemId}">Link de Referência:</label>
            <input type="url" id="link-referencia-${itemId}" class="input-url link-referencia-input" placeholder=""/>
            <small>Obrigatório. Será "Link 1" no PDF (clicável).</small>
          </div>
        </div>
      </div>`;
      itemsContainer.insertAdjacentHTML("beforeend", itemHTML);
    }

    function removeItem(itemId) {
      document.getElementById(itemId).remove();
    }

    function updateImagePreview(input, previewId) {
      const previewImage = document.getElementById(previewId);
      const itemCard = input.closest(".item-card");
      const fileInput = itemCard.querySelector(".local-file-input");
      const urlInput = itemCard.querySelector(".image-url-input");
      previewImage.style.display = "none";
      previewImage.src = "";

      if (fileInput && fileInput.files && fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = e => {
          previewImage.src = e.target.result;
          previewImage.style.display = "block";
        };
        reader.readAsDataURL(file);
      } else if (urlInput && urlInput.value.trim()) {
        const url = urlInput.value.trim();
        previewImage.src = url;
        previewImage.onload = () => previewImage.style.display = "block";
        previewImage.onerror = () => previewImage.style.display = "none";
      }
    }

    async function urlToDataURL(url) {
      try {
        const response = await fetch(url, { mode: 'cors' });
        if (!response.ok) throw new Error();
        const blob = await response.blob();
        return await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      } catch (e) {
        return null;
      }
    }

    async function saveAsPDF() {
      const itemCards = itemsContainer.querySelectorAll(".item-card");
      if (!itemCards.length) {
        alert("Adicione pelo menos um item.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "mm", "a4");
      const pageWidth = 210;
      const pageHeight = 297;
      const margin = 15;
      const contentWidth = pageWidth - 2 * margin;
      let y = 25;

      // Título
      pdf.setFontSize(18);
      pdf.setTextColor(30, 136, 229);
      const titulo = document.getElementById("orcamentoTitulo").value.trim() || "Orçamento";
      pdf.text(titulo, pageWidth / 2, y, { align: "center" });
      y += 10;

      // Emissão
      pdf.setFontSize(10);
      pdf.setTextColor(100);
      pdf.text(`**Emissão:** ${new Date().toLocaleDateString("pt-BR")}`, margin, y);
      y += 15;

      // Cabeçalho
      pdf.setFontSize(14);
      pdf.setTextColor(51, 51, 51);
      pdf.text("Itens para Orçamento", margin, y);
      y += 10;

      // Itens
      for (let i = 0; i < itemCards.length; i++) {
        const card = itemCards[i];
        const itemId = card.id;
        const nome = document.getElementById(`nome-produto-${itemId}`).value.trim() || `Item ${i + 1}`;
        const qtd = document.getElementById(`quantidade-${itemId}`).value || "1";
        const linkReferencia = document.getElementById(`link-referencia-${itemId}`).value.trim();

        // Imagem
        let imgData = null;
        const previewImg = document.getElementById(`preview-url-${itemId}`);
        const linkImg = document.getElementById(`link-img-${itemId}`).value.trim();

        if (previewImg.src && previewImg.src.startsWith("data:")) {
          imgData = previewImg.src;
        } else if (linkImg) {
          imgData = await urlToDataURL(linkImg);
        }

        const imgX = margin;
        const imgY = y;
        const imgSize = 25;

        if (imgData) {
          try {
            pdf.addImage(imgData, "JPEG", imgX, imgY, imgSize, imgSize);
          } catch (e) {}
        } else {
          pdf.setFontSize(9);
          pdf.setTextColor(150);
          pdf.text("Sem Imagem", imgX, imgY + 15);
        }

        // Texto
        pdf.setFontSize(11);
        pdf.setTextColor(0);
        pdf.text(nome, imgX + imgSize + 8, imgY + 8);

        pdf.setFontSize(9);
        pdf.setTextColor(100);
        pdf.text(`Qtd.: ${qtd}`, imgX + imgSize + 8, imgY + 15);

        pdf.setFontSize(9);
        pdf.setTextColor(40, 167, 69);
        pdf.text(`Item ${i + 1}`, pageWidth - margin - 25, imgY + 15, { align: "right" });

        // Link de Referência
        if (linkReferencia) {
          const linkText = "Link 1";
          const linkX = imgX + imgSize + 8;
          const linkY = imgY + 22;
          pdf.setTextColor(26, 13, 171);
          pdf.textWithLink(linkText, linkX, linkY, { url: linkReferencia });
        }

        y += 35;

        if (y > pageHeight - 30) {
          pdf.addPage();
          y = 25;
        }
      }

      // Rodapé
      pdf.setFontSize(8);
      pdf.setTextColor(120);
      pdf.text("Documento gerado para solicitação de orçamento.", pageWidth / 2, pageHeight - 15, { align: "center" });

      pdf.save("Orcamento_MultiItens.pdf");
    }

    document.getElementById("btnAddItem").addEventListener("click", addItem);
    document.getElementById("btnGerarPDF").addEventListener("click", saveAsPDF);
    document.addEventListener("DOMContentLoaded", addItem);
  </script>
</body>
</html>
